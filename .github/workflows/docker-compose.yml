name: Docker Compose CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  docker-compose:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and run with Docker Compose
      run: |
        docker compose up --build -d
        
    - name: Wait for services to be ready
      run: |
        echo "Waiting for MySQL to be ready..."
        sleep 30
        
        echo "Waiting for Nginx & Spring Boot to be ready..."
        timeout 120 bash -c 'until curl -s http://localhost/health > /dev/null 2>&1; do sleep 5; done' || true

    - name: Check container status
      run: |
        docker compose ps
        docker compose logs app

    - name: Test API endpoint
      run: |
        echo "Testing API health via Nginx..."
        curl -s http://localhost/health || echo "Health check"
        
        echo "Testing Swagger UI via Nginx..."
        curl -s http://localhost/swagger-ui.html || echo "Swagger UI check"
        
        echo "Testing login endpoint via Nginx..."
        curl -s -X POST http://localhost/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username":"admin","password":"password123"}' || echo "Login test completed"

    - name: Cleanup
      if: always()
      run: |
        docker compose down -v
        docker compose logs > docker-compose-logs.txt 2>&1 || true

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: docker-compose-logs
        path: docker-compose-logs.txt
